# Dockerfile-sadtalker
FROM pytorch/pytorch:2.1.2-cuda12.1-cudnn8-devel

# Install the timezone data package
RUN apt-get update && DEBIAN_FRONTEND="noninteractive" \
        apt-get install -y tzdata && \
        rm -rf /var/lib/apt/lists/*

# Set the timezone to Asia/Shanghai
ENV TZ=Asia/Shanghai
# Copy the local time file to the container
RUN cp /usr/share/zoneinfo/$TZ /etc/localtime \
        && echo $TZ > /etc/timezone

RUN apt-get update && DEBIAN_FRONTEND="noninteractive" \
    apt-get install -y git tmux htop vim git-lfs pip wget openssl && \
    rm -rf /var/lib/apt/lists/*

# RUN pip install -U flash-attn --no-build-isolation --use-pep517

RUN pip install --no-cache-dir  \
        -i https://pypi.tuna.tsinghua.edu.cn/simple  \
        --trusted-host pypi.tuna.tsinghua.edu.cn \
        torchaudio \
        torchvision \
        numpy==1.23.4 \
        face_alignment==1.3.5 \
        imageio==2.19.3 \
        imageio-ffmpeg==0.4.7 \
        librosa==0.9.2 #  \
        numba \
        resampy==0.3.1 \
        pydub==0.25.1  \
        scipy==1.10.1 \
        kornia==0.6.8 \
        tqdm \
        yacs==0.1.8 \
        pyyaml  \
        joblib==1.1.0 \
        scikit-image==0.19.3 \
        basicsr==1.4.2 \
        facexlib==0.3.0
        gradio \
        gfpgan \
        av \
        safetensors \
        trimesh==3.9.20 \
        gfpgan

# Install dlib
RUN pip install dlib-bin

RUN wget https://cdn-media.hf-mirror.com/frpc-gradio-0.2/frpc_linux_amd64 && \
    mv frpc_linux_amd64 frpc_linux_amd64_v0.2 && \
    mv frpc_linux_amd64_v0.2 /opt/conda/lib/python3.10/site-packages/gradio/ && \
    chmod 755 /opt/conda/lib/python3.10/site-packages/gradio/frpc_linux_amd64_v0.2

WORKDIR /app
# Inference and training library for high-quality TTS models.
# RUN pip install git+https://github.com/huggingface/parler-tts.git
#COPY ../model/parler_tts /app/parler_tts/
# COPY ../tts/parler-tts /app/parler-tts/
# RUN pip install /app/parler-tts
COPY . /app/SadTalker

# Install GFPGAN
RUN pip install git+https://github.com/TencentARC/GFPGAN

# COPY examples/parler_tts_cli_demo.py /app
# COPY examples/parler_tts_web_gradio.py /app

# RUN chmod u+x /app/parler_tts_cli_demo.py
# RUN chmod u+x /app/parler_tts_web_gradio.py

RUN openssl req -x509 -days 3650 -nodes -newkey rsa  \
    -keyout ./key.pem -out ./cert.pem -subj "/CN=ChatTTS"

EXPOSE 7860

